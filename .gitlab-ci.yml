default:
  image: python:3.10-slim
  cache:
    paths:
      - .cache/pip

variables:
  PIP_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/pip"
  PIP_PROGRESS_BAR: "off"

black:
  stage: test
  needs: []
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install black
  script:
    - black --check --diff --color .

flake8:
  stage: test
  needs: []
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install flake8
  script:
    - flake8 --count .

pycodestyle:
  stage: test
  needs: []
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install pycodestyle
  script:
    - pycodestyle -v --show-source .

mypy:
  stage: test
  allow_failure: true
  needs: []
  before_script:
    - pip install --upgrade pip
    - pip install lxml mypy types-requests
  script:
    - >
      mypy --ignore-missing-imports --pretty --show-error-context
      --junit-xml mypy.junit.xml
      --cobertura-xml-report .
      --lineprecision-report .
      ./
    # TODO: maybe enable the --strict flag later
  artifacts:
    paths:
      - mypy.junit.xml
      - cobertura.xml
      - lineprecision.txt
    reports:
      junit: mypy.junit.xml
      cobertura: cobertura.xml

import:
  stage: test
  needs: []
  allow_failure: true
  parallel:
    matrix:
      - PY_VERSION: ["3.8", "3.9", "3.10"]
  image: docker.io/library/python:${PY_VERSION}
  before_script:
    - apt-get update
    # These are needed to build cartopy or its dependencies
    - apt-get install -y libproj-dev libgeos-dev
    - python --version
    - pip install --upgrade pip
    - pip install numpy netCDF4 matplotlib cdsapi xarray typing_extensions
    # This older version of cartopy is used since it requires a version of proj
    # newer than what Debian packages
    - pip install Cartopy==0.19.0.post1
    - pip install access-atmosphere --index-url http://gitlab.remss.com/api/v4/projects/68/packages/pypi/simple --trusted-host gitlab.remss.com
    - pip install git+http://gitlab.remss.com/Carl/plotting.git
    - pip install git+http://gitlab.remss.com/Carl/rss_lock.git
  script:
    # Comment out the global_map import for now
    - sed -i -e '/from global_map/s/^/# /' make_daily_ACCESS_files.py
    - python -m compileall .
    - python -c 'import make_daily_ACCESS_files'
    - python -c 'import add_land_fraction_to_ACCESS_output'
    - python -c 'import add_ERA5_surface_temperature_to_ACCESS_output'
    - python -c 'import add_atmosphere_to_ACCESS_output'
